window.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("feedbackForm"),t=document.getElementById("name"),n=document.getElementById("phone"),o=(document.getElementById("sendBtn"),(e,t)=>{const n=e.closest(".input-box"),o=n.querySelector(".error-message");n.classList.add("error"),o.textContent=t,o.style.display="block"}),r=e=>{const t=e.closest(".input-box"),n=t.querySelector(".error-message");t.classList.remove("error"),n.style.display="none"},s=()=>{const e=t.value.trim();return e?/^[A-Za-zА-Яа-яІіЇїЄє\s]{3,}$/.test(e)?(r(t),!0):(o(t,"Ім'я містить не допустимі символи"),!1):(o(t,"Це поле не може бути пустим"),!1)},a=()=>{const e=n.value.replace(/\D/g,"");return e?e.length<10?(o(n,"Ви ввели неповний номер"),!1):(r(n),!0):(o(n,"Це поле не може бути пустим"),!1)};n.addEventListener("input",()=>{let e=n.value.replace(/\D/g,"");e.startsWith("380")?e="+"+e:e.startsWith("0")&&(e="+38"+e),n.value=e,a()});const c=document.querySelectorAll('input[name="rating"]'),i=document.querySelector(".rating-error-message"),d=()=>[...c].some(e=>e.checked)?(i.style.visibility="hidden",!0):(i.style.visibility="visible",!1);let l=null;c.forEach(e=>{e.addEventListener("click",e=>{if(l===e.target)return e.target.checked=!1,l=null,void d();l=e.target,d()})}),t.addEventListener("input",s),n.addEventListener("input",a);let m=[];const u=document.querySelector("#photos"),p=document.getElementById("photoPreview"),h=document.querySelector(".form__photo-error");u.addEventListener("change",()=>{const e=Array.from(u.files);let t=m.reduce((e,t)=>e+t.size,0);if(e.forEach(e=>t+=e.size),t>26214400)return h.innerHTML='\n      <p class="form__photo-error-txt form__photo-error-txt--active">\n        Перевищено максимальний розмір 25 МБ. Видаліть зайві файли.\n      </p>\n    ',void(u.value="");e.forEach(e=>m.push(e)),u.value="",v(),g()});const v=()=>{p.innerHTML="",0!==m.length?(m.forEach((e,t)=>{const n=document.createElement("div");n.classList.add("preview__item"),n.innerHTML=`\n      <span class="file-name">${e.name}</span>\n      <button class="delete-file" data-index="${t}">Х</button>\n    `,p.appendChild(n)}),document.querySelectorAll(".delete-file").forEach(e=>{e.addEventListener("click",f)}),g()):h.innerHTML='<p class="form__photo-hint">Доступно для завантаження: 25 МБ Файл</p> '},g=()=>{const e=m.reduce((e,t)=>e+t.size,0),t=26214400,n=t-e,o=e=>(e/1048576).toFixed(2);h.innerHTML=0===e?`<p class="form__photo-error-txt">Файл не вибрано.</p> <p class="form__photo-hint">Доступно для завантаження: ${o(t)} МБ</p>`:`\n        <p class="form__photo-hint">\n          Завантажено: ${o(e)} МБ із 25 МБ<br>\n          Залишилось: ${o(n)} МБ\n        </p>\n      `},f=e=>{const t=e.target.dataset.index;m.splice(t,1),v(),g()},y=new URLSearchParams(window.location.search).get("qr");document.getElementById("qr_id").value=y,e.addEventListener("submit",async o=>{o.preventDefault();const r=s(),i=a();if(!r||!i)return;const d=[...c].find(e=>e.checked)?.value||"0",l=new FormData;l.append("name",t.value.trim()),l.append("phone",n.value.trim()),l.append("rating",d),l.append("message",document.getElementById("message").value.trim()||""),l.append("QR_ID",y),m.forEach(e=>{l.append("photos[]",e)});const u=document.createElement("div");u.classList.add("spinner"),u.innerHTML="<span>Відправка...</span>",e.insertAdjacentElement("afterend",u),console.log("Отправляем рейтинг:",d);try{const t=await fetch("https://shepit.archiviz.biz/mail.php",{method:"POST",body:l}),n=await t.text();console.log(n),u.remove(),E.classList.add("active"),L=setTimeout(()=>{_()},5e3),e.reset(),c.forEach(e=>e.checked=!1),m=[],v()}catch(e){console.error("Мережева помилка або помилка сервера:",e),u.remove(),document.getElementById("formStatus").textContent="Помилка зв'язку з сервером. Перевірте підключення."}});const E=document.getElementById("successMessage");let L;function _(){E.classList.remove("active"),clearTimeout(L)}document.getElementById("closeSuccess").addEventListener("click",_)});